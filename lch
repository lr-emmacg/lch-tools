#!/bin/bash

CSV_FILE=~/cloud/lch-tools/'LXC SaaS Customer Environments - Clusters.csv'

# 1. Ask for Support Account Code (col e)
read -p "Enter Support Account Code: " ACCOUNT
 # convert to uppercase for case-insensitive match
ACCOUNT_UPPER=$(echo "$ACCOUNT" | tr '[:lower:]' '[:upper:]')

# 2. Find matching rows in CSV (col c)
# $5 = Support Account Code. $3 = Env
MATCHES=($(awk -F',' -v acc="$ACCOUNT_UPPER" 'toupper ($5) == acc {print $3}' "$CSV_FILE"))

# 3. List environments and ask user to choose
if [ ${#MATCHES[@]} -eq 0 ]; then
    echo "Support Account Code '$ACCOUNT' not found."
    exit 1
fi

#matches
echo "Found the following environments for $ACCOUNT_UPPER:"

#returns array
for i in "${!MATCHES[@]}"; do
    echo "$((i+1))) ${MATCHES[$i]}"
done

#select one
read -p "Choose Environment [1-${#MATCHES[@]}]: " ENV_IDX

#validate
if [[ "$ENV_IDX" -lt 1 || "$ENV_IDX" -gt ${#MATCHES[@]} ]]; then
    echo "Invalid selection. Exiting."
    exit 1
fi

#setting the env
SELECTED_ENV=${MATCHES[$((ENV_IDX-1))]}

echo "You selected: $SELECTED_ENV"

# find the line in the csv based on the user imput
LINE_NUM=$(awk -F',' -v env="$SELECTED_ENV" '$3 == env {print NR}' "$CSV_FILE")

# extract the fields based on the env string
CLUSTER=$(awk -F',' "NR==$LINE_NUM {print \$1}" "$CSV_FILE")
DXPC_PROJECT=$(awk -F',' "NR==$LINE_NUM {print \$3}" "$CSV_FILE")
MW_DAY=$(awk -F',' "NR==$LINE_NUM {print \$6}" "$CSV_FILE")
MW_TIME=$(awk -F',' "NR==$LINE_NUM {print \$7}" "$CSV_FILE")

# 4. Build the LCH template
# title input (later it will automatically include 'lxc<cluster>-<clusterEnv> - ')
read -p "Enter LCH title: " TITLE

# ticket context
read -p "Enter context for the LCH: " CONTEXT

# numbered requests (optional)
REQUESTS=()
while true; do
    read -p "Enter a request (or press Enter to skip): " REQ
    [[ -z "$REQ" ]] && break # stop when no input
    REQUESTS+=("$REQ")
done

#include hotfix link
read -p "Paste a hotfix link if needed (or press Enter to skip): " HOTFIX

# maintenance window (optional) already pulled
read -p "Include maintenance window? [y/N] (or press Enter to skip): " MW_INCLUDE
MW_SECTION=""
if [[ ! -z "$MW_INCLUDE" && "$MW_INCLUDE" =~ ^[yY] ]]; then
    MW_SECTION="h3. *Maintenance Window:*\n* Day: $MW_DAY\n* Time: $MW_TIME UTC"
fi

# 6. Print to terminal 
FULL_CODE="lxc${CLUSTER}-${DXPC_PROJECT}"
echo ""
echo "$FULL_CODE - $TITLE"
echo ""
echo "Hi team,"
echo ""
echo "$CONTEXT"
echo ""
echo "h3. *Request(s):*"
# req if statement
if [[ ${#REQUESTS[@]} -eq 0 ]]; then
    echo "See context above."
else
    for r in "${REQUESTS[@]}"; do
        echo "* $r"
    done
fi

# mw if statement
echo ""
if [[ ! -z "$MW_SECTION" ]]; then
    echo -e "$MW_SECTION"
    echo ""
fi
echo "h3. *URL(s):*"
echo "* [Cloud Console|https://console.liferay.cloud/projects/$FULL_CODE/overview]"

# hotfix link
echo ""
if [[ -n "$HOTFIX" ]]; then 
    echo "* [Hotfix|$HOTFIX]"
fi

echo ""

echo "Please reach out with any questions"
